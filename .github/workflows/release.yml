name: Release - Parallel Publishing

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*'  # æ”¯æŒä»¥ v å¼€å¤´çš„ç‰ˆæœ¬æ ‡ç­¾ (å¦‚ v1.0.5)

jobs:
  # ğŸ”§ æ„å»ºé˜¶æ®µ - åˆ›å»ºå…±äº«çš„VSIXæ–‡ä»¶
  build:
    runs-on: ubuntu-latest
    outputs:
      package_name: ${{ steps.package.outputs.package_name }}
      version: ${{ steps.package.outputs.version }}
      tag_name: ${{ steps.tag-info.outputs.tag_name }}
      is_tag_push: ${{ steps.tag-info.outputs.is_tag_push }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Detect trigger type and extract tag info
        id: tag-info
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            # Releaseè§¦å‘
            echo "is_tag_push=false" >> $GITHUB_OUTPUT
            echo "tag_name=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
            echo "ğŸ‰ ç”± GitHub Release è§¦å‘: ${{ github.event.release.tag_name }}"
          elif [ "${{ github.event_name }}" == "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Tagæ¨é€è§¦å‘
            echo "is_tag_push=true" >> $GITHUB_OUTPUT
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
            echo "ğŸ·ï¸ ç”± Tag æ¨é€è§¦å‘: ${TAG_NAME}"
          else
            echo "âŒ æœªçŸ¥çš„è§¦å‘æ–¹å¼"
            exit 1
          fi
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build extension
        run: npm run vscode:prepublish
      
      - name: Package extension
        id: package
        run: |
          # ä» package.json ä¸­è¯»å–ç‰ˆæœ¬å·
          VERSION=$(node -p "require('./package.json').version")
          PACKAGE_NAME="xkcoding-api-navigator-v${VERSION}.vsix"
          npx @vscode/vsce package --out "${PACKAGE_NAME}"
          echo "package_name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "âœ… æ‰©å±•æ‰“åŒ…å®Œæˆ: ${PACKAGE_NAME}"
      
      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-package
          path: ${{ steps.package.outputs.package_name }}
          retention-days: 7

  # ğŸš€ VSCode Marketplace å‘å¸ƒï¼ˆå¹¶è¡Œä»»åŠ¡1ï¼‰
  publish-vscode:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download VSIX artifact
        uses: actions/download-artifact@v4
        with:
          name: extension-package
      
      - name: Publish to VSCode Marketplace
        id: vscode-publish
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å‘å¸ƒä»¤ç‰Œ
          if [ -z "$VSCE_PAT" ]; then
            echo "âš ï¸ VSCE_PAT æœªè®¾ç½®ï¼Œè·³è¿‡ VSCode Marketplace å‘å¸ƒ"
            exit 0
          fi
          
          echo "ğŸš€ å‘å¸ƒåˆ° VSCode Marketplace..."
          npx @vscode/vsce publish --packagePath ${{ needs.build.outputs.package_name }}
          echo "âœ… VSCode Marketplace å‘å¸ƒæˆåŠŸ"
        continue-on-error: true
      
      - name: Report VSCode publish result
        if: always()
        run: |
          if [ "${{ steps.vscode-publish.outcome }}" == "success" ]; then
            echo "âœ… VSCode Marketplace å‘å¸ƒï¼šæˆåŠŸ"
          else
            echo "âŒ VSCode Marketplace å‘å¸ƒï¼šå¤±è´¥ (çŠ¶æ€: ${{ steps.vscode-publish.outcome }})"
          fi

  # ğŸ“¦ OpenVSX Registry å‘å¸ƒï¼ˆå¹¶è¡Œä»»åŠ¡2ï¼‰
  publish-openvsx:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download VSIX artifact
        uses: actions/download-artifact@v4
        with:
          name: extension-package
      
      - name: Publish to OpenVSX Registry
        id: openvsx-publish
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å‘å¸ƒä»¤ç‰Œ
          if [ -z "$OVSX_PAT" ]; then
            echo "âš ï¸ OVSX_PAT æœªè®¾ç½®ï¼Œè·³è¿‡ OpenVSX Registry å‘å¸ƒ"
            exit 0
          fi
          
          echo "ğŸš€ å‘å¸ƒåˆ° OpenVSX Registry..."
          npx ovsx publish ${{ needs.build.outputs.package_name }} --pat $OVSX_PAT
          echo "âœ… OpenVSX Registry å‘å¸ƒæˆåŠŸ"
        continue-on-error: true
      
      - name: Report OpenVSX publish result
        if: always()
        run: |
          if [ "${{ steps.openvsx-publish.outcome }}" == "success" ]; then
            echo "âœ… OpenVSX Registry å‘å¸ƒï¼šæˆåŠŸ"
          else
            echo "âŒ OpenVSX Registry å‘å¸ƒï¼šå¤±è´¥ (çŠ¶æ€: ${{ steps.openvsx-publish.outcome }})"
          fi

  # ğŸ“ GitHub Release ä¸Šä¼ ï¼ˆå¹¶è¡Œä»»åŠ¡3ï¼‰
  upload-github-release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸ä¸Šä¼ æ–‡ä»¶åˆ° Release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„gitå†å²ï¼ŒåŒ…æ‹¬tags
      
      - name: Download VSIX artifact
        uses: actions/download-artifact@v4
        with:
          name: extension-package
      
      - name: Upload VSIX to GitHub Release
        id: github-upload
        run: |
          echo "ğŸš€ å¤„ç† GitHub Release..."
          TAG_NAME="${{ needs.build.outputs.tag_name }}"
          PACKAGE_NAME="${{ needs.build.outputs.package_name }}"
          
          if [ "${{ needs.build.outputs.is_tag_push }}" == "true" ]; then
            # Tagæ¨é€è§¦å‘ï¼šåˆ›å»ºæˆ–æ›´æ–°Release
            echo "ğŸ“ ä¸º Tag ${TAG_NAME} åˆ›å»º/æ›´æ–° Release..."
            
            # æ£€æŸ¥Releaseæ˜¯å¦å·²å­˜åœ¨
            if gh release view "${TAG_NAME}" >/dev/null 2>&1; then
              echo "ğŸ”„ Release ${TAG_NAME} å·²å­˜åœ¨ï¼Œä¸Šä¼ æ–‡ä»¶..."
              gh release upload "${TAG_NAME}" "${PACKAGE_NAME}" --clobber
            else
                            echo "ğŸ†• åˆ›å»ºæ–°çš„ Release ${TAG_NAME}..."
              
              # è·å– Tag annotation ä½œä¸º Release Notes
              TAG_MESSAGE=$(git tag -l --format='%(contents)' "${TAG_NAME}" 2>/dev/null || echo "")
              
              if [ -n "$TAG_MESSAGE" ] && [ "$TAG_MESSAGE" != "" ]; then
                echo "ğŸ“ ä½¿ç”¨ Tag annotation ä½œä¸º Release Notes"
                gh release create "${TAG_NAME}" "${PACKAGE_NAME}" --title "API Navigator ${TAG_NAME}" --notes "$TAG_MESSAGE"
              else
                echo "ğŸ“ ä½¿ç”¨é»˜è®¤ Release Notes"
                gh release create "${TAG_NAME}" "${PACKAGE_NAME}" --title "API Navigator ${TAG_NAME}" --notes "ğŸš€ API Navigator ${TAG_NAME} è‡ªåŠ¨å‘å¸ƒã€‚VSCode Marketplace å’Œ OpenVSX Registry åŒæ­¥å‘å¸ƒä¸­ï¼Œè¯·è®¿é—® GitHub ä»“åº“æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚"
              fi
            fi
          else
            # Releaseè§¦å‘ï¼šç›´æ¥ä¸Šä¼ æ–‡ä»¶
            echo "ğŸ“ ä¸Šä¼ æ–‡ä»¶åˆ°ç°æœ‰ Release ${TAG_NAME}..."
            gh release upload "${TAG_NAME}" "${PACKAGE_NAME}" --clobber
          fi
          
          echo "âœ… GitHub Release å¤„ç†æˆåŠŸ"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: Report GitHub upload result
        if: always()
        run: |
          if [ "${{ steps.github-upload.outcome }}" == "success" ]; then
            echo "âœ… GitHub Release ä¸Šä¼ ï¼šæˆåŠŸ"
          else
            echo "âŒ GitHub Release ä¸Šä¼ ï¼šå¤±è´¥ (çŠ¶æ€: ${{ steps.github-upload.outcome }})"
          fi

  # ğŸ“Š å‘å¸ƒçŠ¶æ€æ±‡æ€»ï¼ˆæœ€ç»ˆçŠ¶æ€æŠ¥å‘Šï¼‰
  publish-summary:
    needs: [build, publish-vscode, publish-openvsx, upload-github-release]
    runs-on: ubuntu-latest
    if: always()  # å§‹ç»ˆè¿è¡Œï¼Œå³ä½¿å‰é¢çš„ä»»åŠ¡å¤±è´¥
    steps:
      - name: Publish Summary Report
        run: |
          echo "ğŸ“‹ å‘å¸ƒçŠ¶æ€æ±‡æ€»æŠ¥å‘Š"
          echo "===================="
          echo "ğŸ”§ æ„å»ºçŠ¶æ€: ${{ needs.build.result }}"
          echo "ğŸš€ VSCode Marketplace: ${{ needs.publish-vscode.result }}"
          echo "ğŸ“¦ OpenVSX Registry: ${{ needs.publish-openvsx.result }}"
          echo "ğŸ“ GitHub Release: ${{ needs.upload-github-release.result }}"
          echo "===================="
          
          # ç»Ÿè®¡æˆåŠŸçš„å‘å¸ƒå¹³å°æ•°é‡
          SUCCESS_COUNT=0
          TOTAL_COUNT=3
          
          [ "${{ needs.publish-vscode.result }}" == "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          [ "${{ needs.publish-openvsx.result }}" == "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          [ "${{ needs.upload-github-release.result }}" == "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          
          echo "ğŸ“Š å‘å¸ƒæˆåŠŸç‡: ${SUCCESS_COUNT}/${TOTAL_COUNT} å¹³å°"
          
          if [ $SUCCESS_COUNT -eq $TOTAL_COUNT ]; then
            echo "ğŸ‰ æ‰€æœ‰å¹³å°å‘å¸ƒæˆåŠŸï¼"
          elif [ $SUCCESS_COUNT -gt 0 ]; then
            echo "âš ï¸ éƒ¨åˆ†å¹³å°å‘å¸ƒæˆåŠŸï¼Œè¯·æ£€æŸ¥å¤±è´¥çš„å¹³å°"
          else
            echo "âŒ æ‰€æœ‰å¹³å°å‘å¸ƒå¤±è´¥"
            exit 1
          fi
