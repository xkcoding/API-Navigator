name: Release - Parallel Publishing

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*'  # æ”¯æŒä»¥ v å¼€å¤´çš„ç‰ˆæœ¬æ ‡ç­¾ (å¦‚ v1.0.5)

jobs:
  # ğŸ”§ æ„å»ºé˜¶æ®µ - åˆ›å»ºå…±äº«çš„VSIXæ–‡ä»¶
  build:
    runs-on: ubuntu-latest
    outputs:
      package_name: ${{ steps.package.outputs.package_name }}
      version: ${{ steps.package.outputs.version }}
      tag_name: ${{ steps.tag-info.outputs.tag_name }}
      is_tag_push: ${{ steps.tag-info.outputs.is_tag_push }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Detect trigger type and extract tag info
        id: tag-info
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            # Releaseè§¦å‘
            echo "is_tag_push=false" >> $GITHUB_OUTPUT
            echo "tag_name=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
            echo "ğŸ‰ ç”± GitHub Release è§¦å‘: ${{ github.event.release.tag_name }}"
          elif [ "${{ github.event_name }}" == "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Tagæ¨é€è§¦å‘
            echo "is_tag_push=true" >> $GITHUB_OUTPUT
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
            echo "ğŸ·ï¸ ç”± Tag æ¨é€è§¦å‘: ${TAG_NAME}"
          else
            echo "âŒ æœªçŸ¥çš„è§¦å‘æ–¹å¼"
            exit 1
          fi
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build extension
        run: npm run vscode:prepublish
      
      - name: Package extension
        id: package
        run: |
          # ä» package.json ä¸­è¯»å–ç‰ˆæœ¬å·
          VERSION=$(node -p "require('./package.json').version")
          PACKAGE_NAME="xkcoding-api-navigator-v${VERSION}.vsix"
          npx @vscode/vsce package --out "${PACKAGE_NAME}"
          echo "package_name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "âœ… æ‰©å±•æ‰“åŒ…å®Œæˆ: ${PACKAGE_NAME}"
      
      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-package
          path: ${{ steps.package.outputs.package_name }}
          retention-days: 7

  # ğŸš€ VSCode Marketplace å‘å¸ƒï¼ˆå¹¶è¡Œä»»åŠ¡1ï¼‰
  publish-vscode:
    needs: build
    runs-on: ubuntu-latest
    outputs:
      publish_status: ${{ steps.vscode-publish.outputs.status }}
    steps:
      - name: Download VSIX artifact
        uses: actions/download-artifact@v4
        with:
          name: extension-package
      
      - name: Publish to VSCode Marketplace
        id: vscode-publish
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å‘å¸ƒä»¤ç‰Œ
          if [ -z "$VSCE_PAT" ]; then
            echo "âš ï¸ VSCE_PAT æœªè®¾ç½®ï¼Œè·³è¿‡ VSCode Marketplace å‘å¸ƒ"
            echo "status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ğŸš€ å‘å¸ƒåˆ° VSCode Marketplace..."
          if npx @vscode/vsce publish --packagePath ${{ needs.build.outputs.package_name }}; then
            echo "âœ… VSCode Marketplace å‘å¸ƒæˆåŠŸ"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ VSCode Marketplace å‘å¸ƒå¤±è´¥"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
        continue-on-error: true
      
      - name: Report VSCode publish result
        if: always()
        run: |
          PUBLISH_STATUS="${{ steps.vscode-publish.outputs.status }}"
          STEP_OUTCOME="${{ steps.vscode-publish.outcome }}"
          
          if [ "$PUBLISH_STATUS" == "success" ]; then
            echo "âœ… VSCode Marketplace å‘å¸ƒï¼šæˆåŠŸ"
          elif [ "$PUBLISH_STATUS" == "skipped" ]; then
            echo "â­ï¸ VSCode Marketplace å‘å¸ƒï¼šè·³è¿‡ (æœªè®¾ç½® VSCE_PAT)"
          else
            echo "âŒ VSCode Marketplace å‘å¸ƒï¼šå¤±è´¥ (æ­¥éª¤çŠ¶æ€: $STEP_OUTCOME)"
          fi

  # ğŸ“¦ OpenVSX Registry å‘å¸ƒï¼ˆå¹¶è¡Œä»»åŠ¡2ï¼‰
  publish-openvsx:
    needs: build
    runs-on: ubuntu-latest
    outputs:
      publish_status: ${{ steps.openvsx-publish.outputs.status }}
    steps:
      - name: Download VSIX artifact
        uses: actions/download-artifact@v4
        with:
          name: extension-package
      
      - name: Publish to OpenVSX Registry
        id: openvsx-publish
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å‘å¸ƒä»¤ç‰Œ
          if [ -z "$OVSX_PAT" ]; then
            echo "âš ï¸ OVSX_PAT æœªè®¾ç½®ï¼Œè·³è¿‡ OpenVSX Registry å‘å¸ƒ"
            echo "status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ğŸš€ å‘å¸ƒåˆ° OpenVSX Registry..."
          if npx ovsx publish ${{ needs.build.outputs.package_name }} --pat $OVSX_PAT; then
            echo "âœ… OpenVSX Registry å‘å¸ƒæˆåŠŸ"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ OpenVSX Registry å‘å¸ƒå¤±è´¥"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
        continue-on-error: true
      
      - name: Report OpenVSX publish result
        if: always()
        run: |
          PUBLISH_STATUS="${{ steps.openvsx-publish.outputs.status }}"
          STEP_OUTCOME="${{ steps.openvsx-publish.outcome }}"
          
          if [ "$PUBLISH_STATUS" == "success" ]; then
            echo "âœ… OpenVSX Registry å‘å¸ƒï¼šæˆåŠŸ"
          elif [ "$PUBLISH_STATUS" == "skipped" ]; then
            echo "â­ï¸ OpenVSX Registry å‘å¸ƒï¼šè·³è¿‡ (æœªè®¾ç½® OVSX_PAT)"
          else
            echo "âŒ OpenVSX Registry å‘å¸ƒï¼šå¤±è´¥ (æ­¥éª¤çŠ¶æ€: $STEP_OUTCOME)"
          fi

  # ğŸ“ GitHub Release ä¸Šä¼ ï¼ˆå¹¶è¡Œä»»åŠ¡3ï¼‰
  upload-github-release:
    needs: build
    runs-on: ubuntu-latest
    outputs:
      upload_status: ${{ steps.github-upload.outputs.status }}
    permissions:
      contents: write  # å…è®¸ä¸Šä¼ æ–‡ä»¶åˆ° Release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„gitå†å²ï¼ŒåŒ…æ‹¬tags
      
      - name: Download VSIX artifact
        uses: actions/download-artifact@v4
        with:
          name: extension-package
      
      - name: Upload VSIX to GitHub Release
        id: github-upload
        run: |
          echo "ğŸš€ å¤„ç† GitHub Release..."
          TAG_NAME="${{ needs.build.outputs.tag_name }}"
          PACKAGE_NAME="${{ needs.build.outputs.package_name }}"
          
          if [ "${{ needs.build.outputs.is_tag_push }}" == "true" ]; then
            # Tagæ¨é€è§¦å‘ï¼šåˆ›å»ºæˆ–æ›´æ–°Release
            echo "ğŸ“ ä¸º Tag ${TAG_NAME} åˆ›å»º/æ›´æ–° Release..."
            
            # æ£€æŸ¥Releaseæ˜¯å¦å·²å­˜åœ¨
            if gh release view "${TAG_NAME}" >/dev/null 2>&1; then
              echo "ğŸ”„ Release ${TAG_NAME} å·²å­˜åœ¨ï¼Œä¸Šä¼ æ–‡ä»¶..."
              gh release upload "${TAG_NAME}" "${PACKAGE_NAME}" --clobber
            else
              echo "ğŸ†• åˆ›å»ºæ–°çš„ Release ${TAG_NAME}..."
              
              # è·å– Tag annotation ä½œä¸º Release Notesï¼ˆä¿®å¤é€»è¾‘ï¼‰
              echo "ğŸ” è·å– Tag ${TAG_NAME} çš„ annotation..."
              
              # é¦–å…ˆæ£€æŸ¥è¿™æ˜¯å¦æ˜¯ä¸€ä¸ª annotated tag
              TAG_TYPE=$(git cat-file -t "${TAG_NAME}" 2>/dev/null || echo "")
              echo "ğŸ·ï¸ Tag ${TAG_NAME} ç±»å‹: ${TAG_TYPE}"
              
              TAG_MESSAGE=""
              
              if [ "$TAG_TYPE" = "tag" ]; then
                # è¿™æ˜¯ä¸€ä¸ª annotated tagï¼Œè·å– tag annotation
                echo "ğŸ“ æ£€æµ‹åˆ° Annotated Tagï¼Œè·å– tag message..."
                TAG_MESSAGE=$(git tag -l --format='%(contents)' "${TAG_NAME}" 2>/dev/null || echo "")
                
                # å¦‚æœä¸Šé¢çš„æ–¹æ³•å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ git cat-file
                if [ -z "$TAG_MESSAGE" ]; then
                  echo "ğŸ”„ å°è¯•å¤‡ç”¨æ–¹æ³•è·å– annotated tag message..."
                  TAG_MESSAGE=$(git cat-file -p "${TAG_NAME}" 2>/dev/null | sed '1,/^$/d' || echo "")
                fi
              else
                # è¿™æ˜¯ä¸€ä¸ª lightweight tagï¼Œæ²¡æœ‰ç‹¬ç«‹çš„ tag message
                echo "ğŸ·ï¸ æ£€æµ‹åˆ° Lightweight Tagï¼Œæ²¡æœ‰ç‹¬ç«‹çš„ tag annotation"
                TAG_MESSAGE=""
              fi
              
              # æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å–åˆ°æœ‰æ„ä¹‰çš„å†…å®¹
              if [ -n "$TAG_MESSAGE" ] && [ "$TAG_MESSAGE" != "" ] && [ "$TAG_MESSAGE" != "$TAG_NAME" ]; then
                echo "ğŸ“ æˆåŠŸè·å– Tag annotationï¼Œé•¿åº¦: ${#TAG_MESSAGE} å­—ç¬¦"
                echo "ğŸ“„ Release Notes é¢„è§ˆ (å‰100å­—ç¬¦):"
                echo "$TAG_MESSAGE" | head -c 100
                echo ""
                echo "..."
                
                # å°† tag message ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ï¼Œä¿æŒæ ¼å¼
                NOTES_FILE="/tmp/release_notes.md"
                echo "$TAG_MESSAGE" > "$NOTES_FILE"
                
                echo "ğŸ“ ä½¿ç”¨ Tag annotation ä½œä¸º Release Notes"
                gh release create "${TAG_NAME}" "${PACKAGE_NAME}" \
                  --title "API Navigator ${TAG_NAME}" \
                  --notes-file "$NOTES_FILE"
              else
                # æ ¹æ® tag ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤ºä¿¡æ¯
                if [ "$TAG_TYPE" = "tag" ]; then
                  echo "âš ï¸ æ— æ³•è·å– Annotated Tag çš„ annotation å†…å®¹ï¼Œä½¿ç”¨é»˜è®¤ Release Notes"
                else
                  echo "â„¹ï¸ Lightweight Tag æ²¡æœ‰ annotation ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤ Release Notes"
                fi
                
                # åˆ›å»ºé»˜è®¤çš„ Release Notes
                DEFAULT_NOTES_FILE="/tmp/default_release_notes.md"
                {
                  echo "ğŸš€ API Navigator ${TAG_NAME} è‡ªåŠ¨å‘å¸ƒ"
                  echo ""
                  if [ "$TAG_TYPE" = "tag" ]; then
                    echo "ğŸ“ **è¯´æ˜**: æ­¤ç‰ˆæœ¬ä¸º Annotated Tagï¼Œä½†æ— æ³•è·å– tag annotation å†…å®¹ã€‚"
                  else
                    echo "ğŸ“ **è¯´æ˜**: æ­¤ç‰ˆæœ¬ä¸º Lightweight Tagï¼Œæ²¡æœ‰ç‹¬ç«‹çš„å‘å¸ƒè¯´æ˜ã€‚"
                  fi
                  echo ""
                  echo "## ğŸ“¦ å®‰è£…æ–¹å¼"
                  echo ""
                  echo "1. **VSCode Marketplace**: æœç´¢ \"API Navigator\" æˆ–è®¿é—®æ‰©å±•å•†åº—"
                  echo "2. **OpenVSX Registry**: é€‚ç”¨äº VSCodium å’Œå…¶ä»–å…¼å®¹ç¼–è¾‘å™¨"
                  echo "3. **GitHub Release**: ä¸‹è½½ VSIX æ–‡ä»¶æ‰‹åŠ¨å®‰è£…"
                  echo ""
                  echo "## ğŸ”— ç›¸å…³é“¾æ¥"
                  echo ""
                  echo "- ğŸ“ å®Œæ•´æ›´æ–°æ—¥å¿—: [README.md](https://github.com/xkcoding/API-Navigator/blob/main/README.md)"
                  echo "- ğŸ› é—®é¢˜åé¦ˆ: [Issues](https://github.com/xkcoding/API-Navigator/issues)"
                  echo "- ğŸ“– ä½¿ç”¨æ–‡æ¡£: [GitHub ä»“åº“](https://github.com/xkcoding/API-Navigator)"
                  echo ""
                  echo "---"
                  echo "*æ­¤ç‰ˆæœ¬é€šè¿‡ GitHub Actions è‡ªåŠ¨å‘å¸ƒåˆ°å¤šä¸ªå¹³å°*"
                } > "$DEFAULT_NOTES_FILE"
                
                gh release create "${TAG_NAME}" "${PACKAGE_NAME}" \
                  --title "API Navigator ${TAG_NAME}" \
                  --notes-file "$DEFAULT_NOTES_FILE"
              fi
            fi
          else
            # Releaseè§¦å‘ï¼šç›´æ¥ä¸Šä¼ æ–‡ä»¶
            echo "ğŸ“ ä¸Šä¼ æ–‡ä»¶åˆ°ç°æœ‰ Release ${TAG_NAME}..."
            gh release upload "${TAG_NAME}" "${PACKAGE_NAME}" --clobber
          fi
          
          echo "âœ… GitHub Release å¤„ç†æˆåŠŸ"
          echo "status=success" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: Handle GitHub upload failure
        if: failure() && steps.github-upload.outcome == 'failure'
        run: |
          echo "âŒ GitHub Release å¤„ç†å¤±è´¥"
          echo "status=failed" >> $GITHUB_OUTPUT
      
      - name: Report GitHub upload result
        if: always()
        run: |
          UPLOAD_STATUS="${{ steps.github-upload.outputs.status }}"
          STEP_OUTCOME="${{ steps.github-upload.outcome }}"
          
          if [ "$UPLOAD_STATUS" == "success" ]; then
            echo "âœ… GitHub Release ä¸Šä¼ ï¼šæˆåŠŸ"
          else
            echo "âŒ GitHub Release ä¸Šä¼ ï¼šå¤±è´¥ (æ­¥éª¤çŠ¶æ€: $STEP_OUTCOME)"
          fi

  # ğŸ“Š å‘å¸ƒçŠ¶æ€æ±‡æ€»ï¼ˆæœ€ç»ˆçŠ¶æ€æŠ¥å‘Šï¼‰
  publish-summary:
    needs: [build, publish-vscode, publish-openvsx, upload-github-release]
    runs-on: ubuntu-latest
    if: always()  # å§‹ç»ˆè¿è¡Œï¼Œå³ä½¿å‰é¢çš„ä»»åŠ¡å¤±è´¥
    steps:
      - name: Publish Summary Report
        run: |
          echo "ğŸ“‹ å‘å¸ƒçŠ¶æ€æ±‡æ€»æŠ¥å‘Š"
          echo "===================="
          echo "ğŸ”§ æ„å»ºçŠ¶æ€: ${{ needs.build.result }}"
          
          # è·å–å„å¹³å°çš„è¯¦ç»†çŠ¶æ€
          VSCODE_STATUS="${{ needs.publish-vscode.outputs.publish_status }}"
          OPENVSX_STATUS="${{ needs.publish-openvsx.outputs.publish_status }}"
          GITHUB_STATUS="${{ needs.upload-github-release.outputs.upload_status }}"
          
          # å¤„ç†ç©ºçŠ¶æ€ï¼ˆå¤±è´¥æ—¶æ²¡æœ‰è¾“å‡ºï¼‰
          [ -z "$VSCODE_STATUS" ] && VSCODE_STATUS="failed"
          [ -z "$OPENVSX_STATUS" ] && OPENVSX_STATUS="failed"
          [ -z "$GITHUB_STATUS" ] && GITHUB_STATUS="failed"
          
          # æ˜¾ç¤ºå„å¹³å°çŠ¶æ€
          echo "ğŸš€ VSCode Marketplace: $VSCODE_STATUS"
          echo "ğŸ“¦ OpenVSX Registry: $OPENVSX_STATUS"
          echo "ğŸ“ GitHub Release: $GITHUB_STATUS"
          echo "===================="
          
          # ç»Ÿè®¡å„ç§çŠ¶æ€çš„æ•°é‡
          SUCCESS_COUNT=0
          SKIPPED_COUNT=0
          FAILED_COUNT=0
          TOTAL_COUNT=3
          
          # VSCode Marketplace
          case "$VSCODE_STATUS" in
            "success") SUCCESS_COUNT=$((SUCCESS_COUNT + 1)) ;;
            "skipped") SKIPPED_COUNT=$((SKIPPED_COUNT + 1)) ;;
            *) FAILED_COUNT=$((FAILED_COUNT + 1)) ;;
          esac
          
          # OpenVSX Registry
          case "$OPENVSX_STATUS" in
            "success") SUCCESS_COUNT=$((SUCCESS_COUNT + 1)) ;;
            "skipped") SKIPPED_COUNT=$((SKIPPED_COUNT + 1)) ;;
            *) FAILED_COUNT=$((FAILED_COUNT + 1)) ;;
          esac
          
          # GitHub Release
          case "$GITHUB_STATUS" in
            "success") SUCCESS_COUNT=$((SUCCESS_COUNT + 1)) ;;
            "skipped") SKIPPED_COUNT=$((SKIPPED_COUNT + 1)) ;;
            *) FAILED_COUNT=$((FAILED_COUNT + 1)) ;;
          esac
          
          # æ˜¾ç¤ºç»Ÿè®¡ç»“æœ
          echo "ğŸ“Š å‘å¸ƒç»Ÿè®¡:"
          echo "   âœ… æˆåŠŸ: ${SUCCESS_COUNT} ä¸ªå¹³å°"
          echo "   â­ï¸ è·³è¿‡: ${SKIPPED_COUNT} ä¸ªå¹³å°"
          echo "   âŒ å¤±è´¥: ${FAILED_COUNT} ä¸ªå¹³å°"
          
          # æœ€ç»ˆçŠ¶æ€åˆ¤æ–­
          if [ $SUCCESS_COUNT -eq $TOTAL_COUNT ]; then
            echo "ğŸ‰ æ‰€æœ‰å¹³å°å‘å¸ƒæˆåŠŸï¼"
          elif [ $SUCCESS_COUNT -gt 0 ]; then
            if [ $SKIPPED_COUNT -gt 0 ]; then
              echo "âš ï¸ éƒ¨åˆ†å¹³å°å‘å¸ƒæˆåŠŸï¼Œéƒ¨åˆ†å¹³å°è·³è¿‡"
            else
              echo "âš ï¸ éƒ¨åˆ†å¹³å°å‘å¸ƒæˆåŠŸï¼Œè¯·æ£€æŸ¥å¤±è´¥çš„å¹³å°"
            fi
          elif [ $SKIPPED_COUNT -eq $TOTAL_COUNT ]; then
            echo "â­ï¸ æ‰€æœ‰å¹³å°éƒ½è·³è¿‡äº†å‘å¸ƒ"
          else
            echo "âŒ å‘å¸ƒè¿‡ç¨‹ä¸­å‡ºç°å¤±è´¥"
            if [ $FAILED_COUNT -eq $TOTAL_COUNT ]; then
              exit 1
            fi
          fi
