# 系统模式

## 目标架构模式 (VSCode 插件)

### 核心架构模式
- **分层架构**: 表现层、业务层、数据访问层明确分离
- **插件架构**: VSCode Extension API 为基础的插件系统
- **事件驱动架构**: 基于文件变更事件和用户操作事件
- **微服务架构思想**: Worker Threads 作为独立的服务单元

### 设计模式规划
1. **组合模式**: Spring 注解路径组合 (类级别 + 方法级别) ⭐
2. **策略模式**: Spring 注解解析策略，支持不同注解类型
3. **工厂模式**: API 端点对象创建和注解解析器工厂
4. **观察者模式**: 文件变更监听和索引更新通知
5. **代理模式**: Worker Thread 通信代理
6. **单例模式**: 索引管理器和配置管理器
7. **命令模式**: VSCode 命令处理和快捷键绑定

### 数据流模式
```
文件变更事件 → 解析队列 → Worker Thread 处理 → AST 解析 → 
注解提取 → 路径组合 → API 端点构建 → 索引更新 → UI 刷新
```

#### Spring 注解组合数据流 ⭐
```
Java 控制器类 → AST 解析 → 提取类级别 @RequestMapping → 
遍历方法 → 提取方法级别映射注解 → 路径组合算法 → 
完整 API 端点路径 → 存储到索引
```

详细流程:
```typescript
1. 解析控制器类: @RestController + @RequestMapping("/api/users")
   ↓
2. 提取类路径: "/api/users" 
   ↓
3. 遍历每个方法: 
   - @GetMapping("/{id}") → method="GET", path="/{id}"
   - @PostMapping("/register") → method="POST", path="/register"
   ↓
4. 路径组合:
   - "/api/users" + "/{id}" → "/api/users/{id}"
   - "/api/users" + "/register" → "/api/users/register"
   ↓
5. 创建 ApiEndpoint 对象，包含完整路径信息
```

### 缓存模式
- **多级缓存**: 内存缓存 + 文件系统缓存
- **LRU 淘汰**: 最近最少使用的缓存淘汰策略
- **增量更新**: 仅缓存变更的部分
- **缓存预热**: 项目启动时预加载核心数据

## 源架构分析 (IDEA 插件)

### 现有架构模式
- **PSI 访问者模式**: 遍历和解析 Java 语法树
- **贡献者模式**: 扩展 IDEA 的导航和搜索功能
- **索引模式**: 利用 IDEA 的内置索引系统

### 迁移映射
| IDEA 模式 | VSCode 对应模式 | 迁移策略 |
|-----------|----------------|----------|
| PSI 访问者 | AST 解析器 + 访问者 | 使用 Java 解析库重新实现 |
| 贡献者模式 | Extension API | 使用 TreeView 和 Command API |
| 内置索引 | 自建索引系统 | Worker Threads + 内存索引 |
| 导航API | VSCode Navigation | 使用 TextDocument.showTextDocument |

## 组件组织模式

### 模块结构
```
src/
├── core/                    # 核心业务逻辑
│   ├── parser/             # Java 解析器
│   ├── indexer/            # 索引管理
│   └── annotation/         # 注解处理
├── providers/              # VSCode 服务提供者
│   ├── treeview/           # 树视图提供者
│   ├── search/             # 搜索提供者
│   └── command/            # 命令处理器
├── utils/                  # 工具类
├── types/                  # 类型定义
└── workers/                # Worker Thread 脚本
```

### 依赖关系模式
- **单向依赖**: 上层模块依赖下层模块
- **接口隔离**: 通过接口定义模块边界
- **依赖注入**: 使用容器管理对象生命周期

## 性能优化模式

### 异步处理模式
- **非阻塞解析**: 使用 Worker Threads 避免阻塞主线程
- **批处理**: 将多个文件的解析请求合并处理
- **防抖处理**: 延迟处理频繁的文件变更事件

### 内存管理模式
- **对象池**: 复用解析器和AST节点对象
- **弱引用**: 对大型数据结构使用弱引用
- **垃圾回收友好**: 及时释放不需要的对象引用

### 缓存策略模式
- **分层缓存**: L1(内存) + L2(磁盘)
- **版本化缓存**: 基于文件修改时间的缓存失效
- **预取策略**: 预测用户可能访问的数据

## 扩展性模式

### 插件化设计
- **注解处理器插件**: 支持新的 Spring 注解类型
- **UI 扩展点**: 允许第三方扩展侧边栏功能
- **搜索提供者扩展**: 支持自定义搜索逻辑

### 配置驱动模式
- **声明式配置**: 通过配置文件定义支持的注解
- **用户自定义**: 允许用户配置解析规则
- **环境适配**: 根据项目类型自动调整解析策略

## 错误处理模式

### 容错设计
- **优雅降级**: 解析失败时提供基础功能
- **隔离故障**: 单个文件解析错误不影响其他文件
- **重试机制**: 对临时性错误进行自动重试

### 监控和诊断
- **性能监控**: 记录解析时间和内存使用
- **错误日志**: 详细记录错误信息和上下文
- **健康检查**: 定期检查组件状态

## 安全模式

### 沙箱隔离
- **文件系统限制**: 仅访问工作区内的文件
- **进程隔离**: Worker Threads 提供额外隔离层
- **权限最小化**: 只请求必要的 VSCode 权限

### 数据保护
- **本地处理**: 所有数据处理都在本地进行
- **敏感信息过滤**: 避免在日志中记录敏感信息
- **安全传输**: Worker Thread 通信使用安全的消息传递 